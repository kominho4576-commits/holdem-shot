<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<meta name="theme-color" content="#7c6cf4">
<title>Hold’em&SHOT.io</title>
<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" href="icons/icon-192.png">
<!-- Socket.IO 클라이언트 -->
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js" defer></script>
<style>
:root{ --ink:#7c6cf4; --line:#c7c1ff; --soft:#e7e3ff; }
*{box-sizing:border-box} html,body{height:100%;margin:0;background:#fff;color:var(--ink);font-family:system-ui,-apple-system,"Apple SD Gothic Neo",Segoe UI,Roboto,Helvetica,Arial,"Noto Sans KR",sans-serif}
button{border:3px solid var(--ink); background:#fff; color:var(--ink); padding:.6rem 1rem; border-radius:18px; font-weight:900; cursor:pointer; box-shadow:0 0 0 3px var(--soft) inset}
button:disabled{opacity:.5;cursor:not-allowed}
input{border:3px solid var(--ink); background:#fff; color:var(--ink); padding:.6rem 1rem; border-radius:18px; font-weight:800; width:100%; box-shadow:0 0 0 3px var(--soft) inset}
.title{font-size:clamp(28px,6vw,64px);font-weight:900;text-align:center;margin:32px 0 24px}
.container{max-width:980px;margin:0 auto;padding:0 16px 40px}
.sketch{border:4px solid var(--line);border-radius:18px;box-shadow:0 0 0 3px var(--soft) inset;padding:20px 18px;max-width:820px;margin:18px auto;}
.row{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center}
.status{display:flex;align-items:center;gap:8px;margin-top:12px;justify-content:flex-start}
.statusWrap{max-width:820px;margin:8px auto 0;padding:0 2px}
.dot{width:12px;height:12px;border-radius:50%;background:#e44}
.dot.on{background:#2ecc71}
.retry{font-size:.9rem;text-decoration:underline;cursor:pointer}
.helper{margin-top:10px; opacity:.85; font-size:.9rem}
.center{display:flex;justify-content:center;align-items:center}
.screen{display:none} .screen.active{display:block}

/* CONNECTING */
.spinner{animation:spin 1s linear infinite;border:6px solid #e5e1ff;border-top-color:#7c6cf4;border-radius:50%;width:64px;height:64px}
@keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}

/* PLAY SCREEN */
.wrap{height:100vh;display:grid;grid-template-columns:1fr 2px 0.78fr;gap:0}
.board,.roulette{ border:4px solid var(--line); border-radius:20px;position:relative}
.divider{background:var(--line)}
.phase{position:absolute; top:20px; left:20px; font-size:32px; font-weight:900;}
.p2{position:absolute; top:24px; right:24px; display:flex; align-items:center; gap:12px; font-size:40px; font-weight:900; z-index:3;}
.p1{position:absolute; left:20px; bottom:28px; display:flex; align-items:center; gap:12px; font-size:48px; font-weight:900;}
.light{width:16px;height:16px;border-radius:50%; border:3px solid var(--ink); background:#fff; display:inline-block;}
.light.on{ background:#43d17a; border-color:#43d17a }

/* hands & shared */
.handTop{position:absolute; left:50%; transform:translateX(-50%); top:92px; display:flex; gap:24px; z-index:2;}
.shared{position:absolute; left:80px; right:80px; top:340px; display:grid; grid-template-columns:repeat(5,140px); gap:24px; justify-content:center; justify-items:center; align-items:center; z-index:1;}
.card{width:140px; aspect-ratio:2.5/3.5; border:5px solid var(--line); border-radius:14px; display:flex; align-items:center; justify-content:center; font-weight:900; font-size:44px; color:var(--ink); background:#fff; position:relative; overflow:hidden; box-shadow:0 0 0 3px var(--soft) inset; user-select:none; transition:.1s; text-align:center}
.card .big{font-size:44px; line-height:1; }
.card .small{font-size:18px; opacity:.8; margin-top:6px}
.card .big.jokerLabel{ font-size:30px; letter-spacing:1px; }
.card .tagJoker{ font-size:16px; opacity:.75; margin-top:6px }
.back::before{content:""; position:absolute; inset:0; background:repeating-linear-gradient(45deg, rgba(124,108,244,.45) 0 10px, rgba(124,108,244,.15) 10px 20px); opacity:.85;}
.face{background:linear-gradient(180deg,#fff 70%, rgba(124,108,244,.08));}
.handBottom{position:absolute; left:120px; bottom:110px; display:flex; gap:28px; align-items:center;}
.resultLine{position:absolute; left:120px; right:120px; top:520px; text-align:center; font-weight:900; opacity:.95}
.btns{position:absolute; right:140px; bottom:36px; display:flex; gap:12px; align-items:center; font-weight:800; z-index:5;}
.rwrap{height:100%; display:grid; place-items:center}
.drum{position:relative; width:min(420px,72vh); aspect-ratio:1/1; border:5px solid var(--line); border-radius:50%; box-shadow:0 0 0 3px var(--soft) inset; display:grid; place-items:center; overflow:visible; transition: transform 2.2s cubic-bezier(.22,.8,.25,1);}
.centerDot{width:18px; height:18px; border-radius:50%; background:#7c6cf4; opacity:.6}
.hole{position:absolute; width:84px; height:84px; border-radius:50%; border:5px solid var(--line); background:#fff; display:grid; place-items:center; box-shadow:0 0 0 3px var(--soft) inset;}
.hole .bullet{width:46px; height:46px; border-radius:50%; background:#5b5b5b; box-shadow:inset 0 0 0 10px #2b2b2b;}
.hole.selected{outline:4px solid var(--ink); outline-offset:3px; animation:pulse 600ms ease-in-out 1;}
@keyframes pulse{0%{transform:scale(1)}60%{transform:scale(1.07)}100%{transform:scale(1)}}
.arrow{position:absolute; top:-22px; left:50%; transform:translateX(-50%); width:0;height:0;border-left:18px solid transparent;border-right:18px solid transparent;border-top:24px solid var(--ink);}
.infoLine{margin-top:8px;opacity:.85; text-align:center}
.safeText{ color:#2ecc71; font-weight:900 }
.bangText{ color:#e74c3c; font-weight:900 }
.activePanel{outline:4px solid var(--ink); outline-offset:-4px}
.card.selected{outline:4px solid var(--ink); box-shadow:0 0 0 3px var(--ink) inset}
.card.selected-opp{outline:4px dashed var(--ink);}
#rotate{position:fixed; inset:0; background:#fff; color:#7c6cf4; display:none; align-items:center; justify-content:center; text-align:center; padding:24px; z-index:1000;}
#flash{position:fixed; pointer-events:none; inset:0; background:rgba(255,0,0,0.25); opacity:0; z-index:999; }
@keyframes flash1 { 0%{opacity:0} 15%{opacity:1} 100%{opacity:0} }
.flashOnce{ animation: flash1 200ms ease-out 1; }
.roulette.active{ box-shadow:0 0 0 4px var(--line) inset, 0 0 18px rgba(120,90,255,.4);}
@media (max-width:1200px){ .handBottom{left:90px} .shared{left:40px; right:40px; top:300px} .resultLine{top:500px} }
</style>
</head>
<body>
<div id="app"><!-- 단일 루트 --></div>

<script>
const API_BASE = "https://holdem-shot.onrender.com";
let socket = null;
let matchTimer = null;
let MODE = "ai"; // 'ai' | 'pvp'
let PVP = { roomId: null, opponentNick: "PLAYER2" };

// ====== UI (홈) 렌더 ======
document.getElementById('app').innerHTML = `
  <div id="screen-home" class="screen active" aria-hidden="false">
    <div class="title">Hold’em&SHOT.io</div>
    <div class="container">
      <div class="sketch">
        <div class="row">
          <input id="nickname" placeholder="Nickname" />
          <button id="btnQuick">Quick Match</button>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="btnCreate">Create Room</button>
          <div style="display:grid;grid-template-columns:1fr auto;gap:8px;">
            <input id="roomCode" placeholder="Room Code" readonly />
            <button id="btnCopy">Copy</button>
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <input id="joinCode" placeholder="Enter Code to Join" />
          <button id="btnJoin">Join Room</button>
        </div>
        <div class="helper">Create 후 생성된 코드를 상대에게 전달하세요. Join은 받은 코드를 입력합니다.</div>
      </div>
      <div class="statusWrap">
        <div class="status">
          <div id="srvDot" class="dot"></div><div>Server</div>
          <div class="retry" id="retry">↻ Retry</div>
        </div>
      </div>
    </div>
  </div>

  <div id="screen-connecting" class="screen" aria-hidden="true">
    <div class="title">Hold’em&SHOT.io</div>
    <div class="container">
      <div class="sketch center" style="min-height:320px;flex-direction:column;gap:18px">
        <div class="spinner"></div>
        <div id="connectingText" style="font-size:44px;font-weight:900">Matching... <span id="count">8</span>s</div>
      </div>
    </div>
  </div>

  <div id="screen-play" class="screen" aria-hidden="true">
    <div class="wrap">
      <section class="board activePanel" id="board">
        <div class="phase">Phase: <span id="phaseText">Dealing</span> <span id="roundText" style="font-size:18px;opacity:.85">(Round 1)</span></div>
        <div class="p2"><span class="light" id="p2Light"></span> <span id="nameOpp">PLAYER2</span></div>
        <div class="handTop" id="oppHand"></div>
        <div class="shared" id="shared">
          <div class="card back"></div><div class="card back"></div><div class="card back"></div><div class="card back"></div><div class="card back"></div>
        </div>
        <div class="resultLine" id="resultLine"></div>
        <div class="handBottom" id="hand"></div>
        <div class="btns">
          <button id="btnReady" disabled>Ready</button>
          <button id="btnSurrender">Surrender</button>
        </div>
        <div class="p1"><span id="nameYou">PLAYER1</span> <span class="light on" id="p1Light"></span></div>
      </section>
      <div class="divider"></div>
      <section class="roulette" id="roulette">
        <div class="rwrap">
          <div style="position:relative">
            <div class="arrow"></div>
            <div class="drum" id="drum"><div class="centerDot"></div></div>
          </div>
          <div class="infoLine" id="rouletteInfo">Loser spins Russian Roulette (round = bullets)</div>
        </div>
      </section>
    </div>
  </div>

  <div id="rotate"><div class="box"><h2>Rotate to Landscape</h2><p>Mobile supports landscape only.</p></div></div>
  <div id="flash"></div>
`;

const $=id=>document.getElementById(id);
const screens=["home","connecting","play"];
function show(n){
  ["screen-home","screen-connecting","screen-play"].forEach(id=>{
    const on = (id==="screen-"+n);
    $(id).classList.toggle("active", on);
    $(id).setAttribute("aria-hidden", on? "false":"true");
  });
}

function getNick(){ return ($("nickname").value.trim()||"PLAYER"); }

// 서버 체크
function checkServer(){
  fetch(`${API_BASE}/health`)
    .then(r=>r.ok?$('srvDot').classList.add('on'):$('srvDot').classList.remove('on'))
    .catch(()=>$('srvDot').classList.remove('on'));
}
window.addEventListener('DOMContentLoaded', ()=>{
  checkServer();
  $('retry').onclick=(e)=>{e.preventDefault();checkServer();}
});

// Socket 준비
function ensureSocket(){
  if (socket && socket.connected) return;
  socket = io(API_BASE, { transports:["websocket","polling"] });
}

// Quick Match
$("btnQuick").onclick = ()=>{
  ensureSocket();
  MODE = "pvp";
  const nick = getNick();
  socket.emit("qm:join", { nick });

  show("connecting");
  let t=8; $("count").textContent=t;
  matchTimer = setInterval(()=>{
    t--; $("count").textContent=t;
    if (t <= 0) {
      clearInterval(matchTimer);
      // 매칭 실패 → 큐에서 나오고 AI로 폴백
      socket.emit("qm:leave");
      MODE = "ai";
      startGame(nick, randomAINick());
    }
  },1000);
};

function randomAINick(){ const adj=["Swift","Silent","Cool","Neon","Crimson","Azure","Lucky","Wild","Ghost","Iron","Rapid","Mellow","Classic","Turbo","Cosmic"]; const animal=["Raven","Wolf","Tiger","Hawk","Viper","Falcon","Panda","Otter","Lynx","Cobra","Eagle","Shark","Bison","Koala","Gecko"]; return adj[Math.floor(Math.random()*adj.length)] + "_" + animal[Math.floor(Math.random()*adj.length)] + "_" + Math.floor(Math.random()*90+10); }

// QM 수신
ensureSocket();
socket?.on("qm:queued", ()=>{/* 대기중 UI면 충분 */});
socket?.on("qm:found", ({ roomId, opponentNick })=>{
  if (matchTimer) { clearInterval(matchTimer); matchTimer=null; }
  PVP.roomId = roomId;
  PVP.opponentNick = opponentNick || "PLAYER2";
  startGame(getNick(), PVP.opponentNick);
});

// Create/Join (코드 매칭)
$("btnCreate").onclick = ()=>{
  ensureSocket();
  const nick = getNick();
  socket.emit("room:create", { nick });
};
$("btnCopy").onclick = ()=>{
  const v = $("roomCode").value.trim();
  if(!v) return;
  navigator.clipboard.writeText(v);
};
socket?.on("room:created", ({ roomId })=>{
  $("roomCode").value = roomId; // 직접 입력 금지, 생성만!
});

$("btnJoin").onclick = ()=>{
  ensureSocket();
  const code = $("joinCode").value.trim().toUpperCase();
  if(!code) return alert("Enter room code.");
  socket.emit("room:join", { roomId: code, nick: getNick() });
};
socket?.on("room:ready", ({ roomId, opponentNick })=>{
  MODE = "pvp";
  PVP.roomId = roomId;
  PVP.opponentNick = opponentNick || "PLAYER2";
  startGame(getNick(), PVP.opponentNick);
});
socket?.on("room:error", ({message})=> alert(message||"Room error"));
socket?.on("room:peer-left", ()=> alert("Opponent left."));

/* ===== 게임 로직: 내 카드는 항상 공개 렌더 (상대는 쇼다운 전까지 뒷면) ===== */
const SUITS=["♠","♥","♦","♣"], RANKS=["A","2","3","4","5","6","7","8","9","10","J","Q","K"];
const shuffle=a=>{for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a};
const deal=(d,n)=>d.splice(0,n);
const deckNew=_=>{const d=[]; for(const s of SUITS){ for(const r of RANKS){ d.push({rank:r,suit:s}); } } d.push({joker:true}); d.push({joker:true}); return d;};

const RANK_ORDER = ["2","3","4","5","6","7","8","9","10","J","Q","K","A"];
const RANK_TO_I = Object.fromEntries(RANK_ORDER.map((r,i)=>[r,i]));
function isFlush5(cards){ const s = cards.map(c=>c.suit); return s.every(x=>x===s[0]); }
function isFour(cards){ const c={}; cards.forEach(k=>c[k.rank]=(c[k.rank]||0)+1); return Object.values(c).includes(4); }
function isFullHouse(cards){ const c={}; cards.forEach(k=>c[k.rank]=(c[k.rank]||0)+1); const v=Object.values(c).sort((a,b)=>b-a); return v[0]===3&&v[1]===2; }
function isThree(cards){ const c={}; cards.forEach(k=>c[k.rank]=(c[k.rank]||0)+1); return Object.values(c).includes(3); }
function pairCounts(cards){ const c={}; cards.forEach(k=>c[k.rank]=(c[k.rank]||0)+1); return Object.values(c).filter(v=>v===2).length; }
function isStraight5(cards){
  const uniq=[...new Set(cards.map(c=>RANK_TO_I[c.rank]))]; if(uniq.length<5) return false; uniq.sort((a,b)=>a-b);
  for(let s=0;s<13;s++){ let ok=true; for(let k=0;k<5;k++){ const v=(s+k)%13; if(!uniq.includes(v)){ ok=false; break; } } if(ok) return true; }
  return false;
}
function scoreName5(cards){
  const f=isFlush5(cards), st=isStraight5(cards);
  if(f&&st) return {score:8,name:"Straight Flush"};
  if(isFour(cards)) return {score:7,name:"Four of a Kind"};
  if(isFullHouse(cards)) return {score:6,name:"Full House"};
  if(f) return {score:5,name:"Flush"};
  if(st) return {score:4,name:"Straight"};
  if(isThree(cards)) return {score:3,name:"Three of a Kind"};
  const pc=pairCounts(cards); if(pc>=2) return {score:2,name:"Two Pair"};
  if(pc===1) return {score:1,name:"One Pair"};
  return {score:0,name:"High Card"};
}
function allComb5(arr){ const res=[]; const n=arr.length;
  for(let a=0;a<n-4;a++)for(let b=a+1;b<n-3;b++)for(let c=b+1;c<n-2;c++)for(let d=c+1;d<n-1;d++)for(let e=d+1;e<n;e++) res.push([arr[a],arr[b],arr[c],arr[d],arr[e]]);
  return res;
}
function bestFrom7(seven){
  const combs=allComb5(seven); let best=null;
  for(const c5 of combs){ const sn=scoreName5(c5); if(!best || sn.score>best.score) best={score:sn.score,name:sn.name,cards:c5}; }
  return best;
}
function cardHTML(c){
  if(c.joker && c.trRank && c.trSuit) return `<div class="big">${c.trRank}${c.trSuit}</div><div class="tagJoker">(JOKER)</div>`;
  if(c.joker) return `<div class="big jokerLabel">JOKER</div>`;
  return `<div class="big">${c.rank}${c.suit}</div>`;
}

const Game=(()=>{
  const S={ you:{name:"PLAYER",hand:[]}, opp:{name:"AI",hand:[]}, shared:[], deck:[], round:1, phase:"Dealing", turn:"you" };

  function renderNames(){ $("nameYou").textContent=S.you.name; $("nameOpp").textContent=S.opp.name; }
  function setPhase(p){ S.phase=p; $("phaseText").textContent=p; $("roundText").textContent=`(Round ${S.round})`; }

  function render(){
    // 상대 패: 쇼다운 전까지 back
    const opp=$("oppHand"); opp.innerHTML="";
    const revealOpp = (S.phase==="Showdown");
    S.opp.hand.forEach((c)=> opp.insertAdjacentHTML("beforeend", `<div class="card ${revealOpp?'face':'back'}">${revealOpp?cardHTML(c):""}</div>`));

    // 내 패: 항상 공개
    const hand=$("hand"); hand.innerHTML="";
    S.you.hand.forEach((c,i)=> hand.insertAdjacentHTML("beforeend", `<div class="card face" data-index="${i}">${cardHTML(c)}</div>`));

    // 공유카드
    const flats=[...document.querySelectorAll("#shared .card")];
    S.shared.slice(0,5).forEach((c,i)=>{ flats[i].className="card "+(c.back?"back":"face"); flats[i].innerHTML=c.back?"":cardHTML(c); });

    // Ready 버튼 활성화(단순)
    $("btnReady").disabled = !(S.phase==="Flop"||S.phase==="Turn"||S.phase==="River");
  }

  function nextPhase(){
    if(S.phase==="Dealing"){ setPhase("Flop"); // 3장 공개
      for(let i=0;i<3;i++){ S.shared[i]=drawNonJoker(); } render();
    } else if(S.phase==="Flop"){ setPhase("Turn"); S.shared[3]=drawNonJoker(); render();
    } else if(S.phase==="Turn"){ setPhase("River"); S.shared[4]=drawNonJoker(); render();
    } else if(S.phase==="River"){ setPhase("Showdown"); render(); }
  }

  function drawNonJoker(){
    let c = S.deck.shift();
    while(c && c.joker){ S.deck.push({joker:true}); S.deck=shuffle(S.deck); c=S.deck.shift(); }
    return c;
  }

  function newRound(){
    S.deck=shuffle(deckNew());
    S.shared=[{back:true},{back:true},{back:true},{back:true},{back:true}];
    S.you.hand=deal(S.deck,2);
    S.opp.hand=deal(S.deck,2);
    setPhase("Dealing");
    render();
    setTimeout(()=> nextPhase(), 800);
  }

  $("btnReady").onclick=()=> nextPhase();
  $("btnSurrender").onclick=()=> location.reload();

  function start(nickYou, nickOpp){
    S.you.name = nickYou || "PLAYER";
    S.opp.name = nickOpp || "AI_Bot";
    renderNames();
    show("play");
    newRound();
  }

  return { start };
})();

function startGame(nickYou, nickOpp){
  // 이름 세팅 + 화면 전환
  $("nameYou").textContent = nickYou;
  $("nameOpp").textContent = nickOpp;
  show("play");
  Game.start(nickYou, nickOpp);
}

// PWA SW
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=> navigator.serviceWorker.register('sw.js').catch(()=>{}));
}
</script>
</body>
</html>
